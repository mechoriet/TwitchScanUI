<!-- Navigation Bar -->
<nav class="navbar main-nav navbar-expand-lg navbar-dark bg-dark fixed-top border-glow-transition"
    [ngClass]="{'h-0 border-bottom border-secondary': userData !== undefined, 'border-glow': userData === undefined}"  @fadeInOut>
    <div class="container-fluid my-1">
        <!-- Brand Icon -->
        <a class="navbar-brand pointer position-absolute ms-2" *ngIf="userData===undefined" @fadeInOut>
            <i class="fa-solid fa-spider text-warning home-icon"></i>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div *ngIf="userData==undefined" class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mx-auto">
                <li class="nav-item my-1" style="width: 50vw;">
                    <div class="input-group rounded flex-grow-1 me-2">
                        <span class="input-group-text bg-dark border-secondary text-light" id="basic-addon1">
                            <i class="fa-brands fa-twitch"></i>
                        </span>
                        <input #userNameInput class="form-control bg-dark border-secondary text-light" type="text"
                            [(ngModel)]="username" [disabled]="loading" placeholder="Enter Twitch channel username"
                            (keyup.enter)="fetchNewData();userNameInput.focus()" aria-label="Twitch channel username" />
                        <button *ngIf="userData===undefined" class="btn btn-dark border-secondary" type="button"
                            (click)="fetchNewData()" title="Start Monitoring">
                            <i class="fa-solid fa-play text-warning"></i>
                        </button>
                        <button *ngIf="loading" class="btn btn-dark border-secondary" type="button"
                            title="Loading data..." disabled>
                            <i class="fa-solid fa-spinner fa-spin"></i>
                        </button>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Button Controls -->
    <div *ngIf="userData!==undefined" @fadeInOut
        class="btn-controls position-absolute border-secondary border-start border-bottom border-end bottom-0 start-0 ms-3 rounded-bottom bg-dark">
        <button class="btn top-index border-secondary rounded-0 border-0" type="button" (click)="reset()">
            <i class="fa-solid fa-arrow-left text-warning"></i>
        </button>
        <button *ngIf="viewCountHistory.length>0" @fadeInOut class="btn top-index border-secondary rounded-0 border-0"
            type="button" data-bs-toggle="collapse" data-bs-target="#viewCountHistory" aria-expanded="false"
            aria-controls="viewCountHistory">
            <i class="fa-solid fa-calendar-day text-warning"></i>
        </button>
    </div>
</nav>

<!-- View Count History -->
<div *ngIf="viewCountHistory.length>0" @fadeInOut id="viewCountHistory"
    class="history-container top-index collapse position-fixed top-0 bg-dark border-glow p-2 rounded border-secondary ms-3">
    <div>
        <div>
            <app-heatmap-selection [timelines]="viewCountHistory"
                (idSelected)="onHistoryDateSelected($event)"></app-heatmap-selection>
        </div>
    </div>
</div>

<!-- Loading Spinner with Backdrop -->
<div class="loading-backdrop" *ngIf="loading">
    <i class="fa-solid fa-spider fa-flip text-warning"></i>
</div>

<!-- Alerts -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div class="toast align-items-center text-bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true"
        [class.show]="notDismissed">
        <div class="d-flex">
            <div class="toast-body">
                <p class="text-danger text-center"><strong>Important Notice</strong></p>
                <p>This project is still very much a work in progress. As such, there may be bugs and issues that
                    need to be resolved.<br>
                    <small>You can reach me at <a class="text-decoration-none" href="mailto:kappa@twitchtrends.tv"><i
                                class="fa-solid fa-envelope"></i>{{'kappa@twitchtrends.tv'}}</a></small>
                </p>
                <p>The app works with live data. To begin, enter a Twitch username and press "Enter" to start
                    monitoring the channel.</p>
                <p>Once monitoring is initiated, data will gradually accumulate after a short delay. Depending on
                    channel activity, this process may take a few minutes.</p>
                <p class="text-danger"><strong>Note:</strong> Data persistence is not guaranteed, as live updates are
                    ongoing, and the public API regularly cleans data.</p>
            </div>
            <button type="button" class="btn-close btn-close-black position-absolute top-0 end-0 mt-4 me-4"
                data-bs-dismiss="toast" aria-label="Close" (click)="saveDismissed()"></button>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container-fluid my-5 py-3">

    <!-- Information Alert -->
    <div class="alert alert-info" *ngIf="info" @fadeInOut>
        <strong>Information:</strong> {{ info }}
        <button type="button" class="btn-close position-absolute end-0 me-3" (click)="info = ''"></button>
    </div>

    <!-- Previously Added Channels -->
    <div class="card container bg-dark text-light border-secondary mt-2 p-0"
        *ngIf="userData === undefined && initiatedChannels.length > 0">
        <!-- Filter Input for Channels -->
        <div class="card-header d-flex justify-content-between align-items-center p-0">
            <div class="input-group">
                <input type="text"
                    class="form-control bg-dark border-secondary text-light m-0 rounded-0 border-0 border-bottom rounded-top p-2"
                    placeholder="Filter channels by name..." [(ngModel)]="channelFilter">
                <button class="btn btn-dark border-secondary rounded-0 border-0 border-bottom rounded-top"
                    (click)="fetchInitiatedChannels()" title="Refetch Data">
                    <i class="fa-solid fa-rotate-right" [class.spin]="loading"></i>
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-dark table-borderless table-striped table-hover m-0">
                <thead>
                    <tr class="border-bottom border-secondary">
                        <th scope="col">Channel</th>
                        <th scope="col" class="text-center">Messages</th>
                        <th scope="col" class="text-center">Created</th>
                    </tr>
                </thead>
                <tbody [@listAnimation]="initiatedChannels.length">
                    <tr class="pointer" *ngFor="let channel of filteredChannels(); trackBy: trackByChannelId"
                        (click)="username = channel.channelName; fetchNewData()" @moveAnimation>
                        <td>
                            <div class="position-relative d-inline-block">
                                <div class="thumbnail-overlay fw-bold top-0 end-0" *ngIf="channel.viewerCount>0" style="border-bottom-left-radius: 5px;">
                                    <span>
                                        {{channel.viewerCount | numberAbbreviator}}
                                    </span>
                                </div>
                                <div class="thumbnail-overlay fw-bold bottom-0 start-50 translate-middle-x w-75 rounded-top" *ngIf="channel.isOnline&&channel.uptime">
                                    <span>
                                        {{getTimeSince(channel.uptime)}}
                                    </span>
                                </div>
                                <img class="rounded" style="width: 110px; height: 62px;"
                                    [src]="'https://static-cdn.jtvnw.net/previews-ttv/live_user_' + channel.channelName + '-110x62.jpg'"
                                    alt="Channel Thumbnail" />
                            </div>
                            <span class="fw-bold ms-2">
                                <i class="fa-circle"
                                    [ngClass]="{'fa-solid text-success': channel.isOnline, 'fa-regular text-danger': !channel.isOnline}"></i>
                                {{ channel.channelName }}
                            </span>
                        </td>
                        <td class="text-center align-middle">{{ channel.messageCount }}</td>
                        <td class="text-center align-middle">{{ getFormattedDateSince(channel.createdAt) }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- User Data Section -->
    <div *ngIf="userData !== undefined" @fadeInOut>
        <app-user-section [username]="username" [data]="userData" [isOnline]="isOnline"></app-user-section>
    </div>
</div>